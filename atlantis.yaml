version: 3
workflows:
  local-state:
    plan:
      steps:
        - init
        - plan
    apply:
      steps:
        - apply
        - run: |
            echo "Committing updated local state"
            env > /tmp/atlantisenv
            git config user.name "atlantis"
            git config user.email "atlantis@example.com"
            git add terraform.tfstate terraform.tfstate.backup || true
            git commit -m "Update local Terraform state [skip ci]" || echo "No changes to commit"
            git push origin HEAD:${ATLANTIS_PULL_HEAD_BRANCH}
projects:
  - name: project1
    dir: project1
    workflow: local-state
    autoplan:
      enabled: true
